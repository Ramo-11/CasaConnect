<!-- Add this hidden data container right after the page header -->
<div id="tenantData" style="display:none;" 
     data-tenant-id="<%= tenant._id %>"
     data-tenant-name="<%= tenant.firstName %> <%= tenant.lastName %>"
     data-tenant-email="<%= tenant.email %>"
     data-unit-number="<%= activeLease && activeLease.unit ? activeLease.unit.unitNumber : '' %>">
</div>

<!-- Tenant Details Page -->
<div class="tenant-details-container" data-tenant-id="<%= tenant._id %>">
    <!-- Page Header -->
    <%- include('../partials/page-header', {
        headerTitle: 'Tenant Details',
        headerSubtitle: `${tenant.firstName} ${tenant.lastName}`,
        backUrl: '/manager/dashboard',
        backText: 'Back to Dashboard',
        headerActions: [
            {
                text: 'Edit Tenant',
                icon: 'fas fa-edit',
                onclick: `editTenant('${tenant._id}')`,
                btnClass: 'btn-primary'
            }
        ]
    }) %>

    <!-- Main Content Grid -->
    <div class="details-grid">
        <!-- Personal Information Card -->
        <div class="card">
            <div class="card-header">
                <h3>Personal Information</h3>
                <span
                    class="badge <%= tenant.isActive ? 'badge-success' : 'badge-danger' %>"
                >
                    <%= tenant.isActive ? 'Active' : 'Inactive' %>
                </span>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div class="info-item">
                        <label>Full Name</label>
                        <span
                            ><%= tenant.firstName %> <%= tenant.lastName
                            %></span
                        >
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <span
                            ><a href="mailto:<%= tenant.email %>"
                                ><%= tenant.email %></a
                            ></span
                        >
                    </div>
                    <div class="info-item">
                        <label>Phone</label>
                        <span
                            ><a href="tel:<%= tenant.phone %>"
                                ><%= tenant.phone %></a
                            ></span
                        >
                    </div>
                    <div class="info-item">
                        <label>Member Since</label>
                        <span
                            ><%= new
                            Date(tenant.createdAt).toLocaleDateString('en-US', {
                            month: 'long', day: 'numeric', year: 'numeric' })
                            %></span
                        >
                    </div>
                    <div class="info-item">
                        <label>Last Login</label>
                        <span
                            ><%= tenant.lastLogin ? new
                            Date(tenant.lastLogin).toLocaleString() : 'Never'
                            %></span
                        >
                    </div>
                </div>

                <div class="action-row">
                    <button
                        class="btn btn-secondary"
                        onclick="sendCredentials('<%= tenant._id %>')"
                    >
                        <i class="fas fa-envelope"></i> Send Login Credentials
                    </button>
                    <button
                        class="btn btn-secondary"
                        onclick="resetPassword('<%= tenant._id %>')"
                    >
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                </div>
            </div>
        </div>

        <!-- Lease Information Card -->
        <div class="card">
            <div class="card-header">
                <h3>Lease Information</h3>
                <% if (activeLease) { %>
                <a href="/manager/lease/<%= activeLease._id %>" class="btn-link"
                    >View Lease</a
                >
                <% } %>
            </div>
            <div class="card-body">
                <% if (activeLease && activeLease.unit) { %>
                <div class="lease-details-box">
                    <div class="lease-header">
                        <h4>Unit <%= activeLease.unit.unitNumber %></h4>
                        <span class="badge badge-<%= activeLease.status %>"
                            ><%= activeLease.status %></span
                        >
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Lease Start</label>
                            <span
                                ><%= new
                                Date(activeLease.startDate).toLocaleDateString()
                                %></span
                            >
                        </div>
                        <div class="info-item">
                            <label>Lease End</label>
                            <span
                                ><%= new
                                Date(activeLease.endDate).toLocaleDateString()
                                %></span
                            >
                        </div>
                        <div class="info-item">
                            <label>Monthly Rent</label>
                            <span class="rent-amount"
                                >$<%= activeLease.monthlyRent %></span
                            >
                        </div>
                        <div class="info-item">
                            <label>Security Deposit</label>
                            <span>$<%= activeLease.securityDeposit %></span>
                        </div>
                        <div class="info-item">
                            <label>Rent Due Day</label>
                            <span
                                >Day <%= activeLease.rentDueDay %> of
                                month</span
                            >
                        </div>
                        <div class="info-item">
                            <label>Days Remaining</label>
                            <span><%= activeLease.daysRemaining %> days</span>
                        </div>
                    </div>

                    <div class="unit-details">
                        <h5>Unit Details</h5>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Type</label>
                                <span
                                    ><%= activeLease.unit.propertyType %></span
                                >
                            </div>
                            <div class="info-item">
                                <label>Bedrooms</label>
                                <span><%= activeLease.unit.bedrooms %></span>
                            </div>
                            <div class="info-item">
                                <label>Bathrooms</label>
                                <span><%= activeLease.unit.bathrooms %></span>
                            </div>
                            <div class="info-item">
                                <label>Square Feet</label>
                                <span
                                    ><%= activeLease.unit.squareFeet %> sq
                                    ft</span
                                >
                            </div>
                        </div>
                    </div>

                    <% if (activeLease.unit.amenities &&
                    activeLease.unit.amenities.length > 0) { %>
                    <div class="amenities-section">
                        <label>Amenities</label>
                        <div class="amenities-list">
                            <% activeLease.unit.amenities.forEach(amenity => {
                            %>
                            <span class="amenity-tag"><%= amenity %></span>
                            <% }) %>
                        </div>
                    </div>
                    <% } %>
                </div>
                <% } else { %>
                <div class="empty-state-small">
                    <i class="fas fa-file-contract"></i>
                    <p>No active lease</p>
                    <button
                        class="btn btn-primary"
                        onclick="openCreateLeaseModal('<%= tenant._id %>', null)"
                    >
                        Create Lease
                    </button>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Payment History Card -->
        <div class="card full-width">
            <div class="card-header">
                <h3>Payment History</h3>
                <div class="header-stats">
                    <div class="mini-stat">
                        <span class="label">Total Paid</span>
                        <span class="value"
                            >$<%= payments.reduce((sum, p) => p.status ===
                            'completed' ? sum + p.amount : sum, 0).toFixed(2)
                            %></span
                        >
                    </div>
                    <div class="mini-stat">
                        <span class="label">Last Payment</span>
                        <span class="value"
                            ><%= payments.length > 0 ? new
                            Date(payments[0].createdAt).toLocaleDateString() :
                            'N/A' %></span
                        >
                    </div>
                </div>
            </div>
            <div class="card-body">
                <% if (payments && payments.length > 0) { %>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Transaction ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% payments.forEach(payment => { %>
                            <tr>
                                <td>
                                    <%= new
                                    Date(payment.createdAt).toLocaleDateString()
                                    %>
                                </td>
                                <td>
                                    <span
                                        class="type-badge type-<%= payment.type %>"
                                    >
                                        <%= payment.type.replace('_', ' ') %>
                                    </span>
                                </td>
                                <td class="amount">
                                    $<%= payment.amount.toFixed(2) %>
                                </td>
                                <td>
                                    <%= payment.paymentMethod.replace('_', ' ')
                                    %>
                                </td>
                                <td>
                                    <span
                                        class="badge status-<%= payment.status %>"
                                    >
                                        <%= payment.status %>
                                    </span>
                                </td>
                                <td class="transaction-id">
                                    <%= payment.transactionId || '-' %>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
                <% } else { %>
                <div class="empty-state-small">
                    <i class="fas fa-dollar-sign"></i>
                    <p>No payment history available</p>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Service Requests Card -->
        <div class="card full-width">
            <div class="card-header">
                <h3>Service Requests</h3>
                <div class="header-stats">
                    <div class="mini-stat">
                        <span class="label">Total Requests</span>
                        <span class="value"><%= serviceRequests.length %></span>
                    </div>
                    <div class="mini-stat">
                        <span class="label">Pending</span>
                        <span class="value"
                            ><%= serviceRequests.filter(r => r.status ===
                            'pending').length %></span
                        >
                    </div>
                </div>
            </div>
            <div class="card-body">
                <% if (serviceRequests && serviceRequests.length > 0) { %>
                <div class="requests-list">
                    <% serviceRequests.forEach(request => { %>
                    <div class="request-item-detailed">
                        <div
                            class="request-priority priority-<%= request.priority %>"
                        ></div>
                        <div class="request-content">
                            <div class="request-header">
                                <h4><%= request.title %></h4>
                                <span class="badge status-<%= request.status %>"
                                    ><%= request.status.replace('_', ' ')
                                    %></span
                                >
                            </div>
                            <div class="request-meta">
                                <span
                                    ><i class="fas fa-calendar"></i> <%= new
                                    Date(request.createdAt).toLocaleDateString()
                                    %></span
                                >
                                <span
                                    ><i class="fas fa-tag"></i> <%=
                                    request.category.replace('_', ' ') %></span
                                >
                                <span class="priority-<%= request.priority %>">
                                    <i class="fas fa-flag"></i> <%=
                                    request.priority %>
                                </span>
                            </div>
                            <p class="request-description">
                                <%= request.description %>
                            </p>
                        </div>
                        <div class="request-actions">
                            <button
                                class="btn-icon"
                                onclick="viewRequest('<%= request._id %>')"
                                title="View"
                            >
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <% }) %>
                </div>
                <% } else { %>
                <div class="empty-state-small">
                    <i class="fas fa-tools"></i>
                    <p>No service requests submitted</p>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Documents Card -->
        <div class="card full-width">
            <div class="card-header">
                <h3>Documents</h3>
                <button
                    class="btn btn-primary btn-small"
                    onclick="attachDocument('<%= tenant._id %>', 'User', '<%= hasActiveLease %>')"
                >
                    <i class="fas fa-upload"></i> Upload Document
                </button>
            </div>
            <div class="card-body">
                <div id="documentsContainer" class="documents-list">
                    <div class="loading-spinner">Loading documents...</div>
                </div>
            </div>
        </div>

        <!-- Account Actions Card -->
        <div class="card full-width">
            <div class="card-header">
                <h3>Account Actions</h3>
            </div>
            <div class="card-body">
                <div class="action-grid">
                    <!-- <button
                        class="action-button"
                        onclick="sendNotification('<%= tenant._id %>')"
                    >
                        <i class="fas fa-bell"></i>
                        <span>Send Notification</span>
                    </button> -->
                    <% if (!activeLease) { %>
                    <button
                        class="action-button"
                        onclick="openCreateLeaseModal('<%= tenant._id %>')"
                    >
                        <i class="fas fa-file-contract"></i>
                        <span>Create Lease</span>
                    </button>
                    <% } %>
                    <% if (tenant.isActive) { %>
                    <button
                        class="action-button warning"
                        onclick="suspendAccount('<%= tenant._id %>')"
                    >
                        <i class="fas fa-pause-circle"></i>
                        <span>Suspend Account</span>
                    </button>
                    <% } else { %>
                    <button
                        class="action-button warning"
                        onclick="activateAccount('<%= tenant._id %>')"
                    >
                        <i class="fas fa-play-circle"></i>
                        <span>Activate Account</span>
                    </button>
                    <% } %>
                    <button
                        class="action-button danger"
                        onclick="deleteTenant('<%= tenant._id %>')"
                    >
                        <i class="fas fa-trash"></i>
                        <span>Delete Tenant</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
