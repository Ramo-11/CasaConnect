<!-- Service Requests Management -->
<div class="service-requests-container">
    <!-- Filters and Search -->
    <div class="requests-filters">
        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterByStatus('all')">
                All Requests
                <span class="count"><%= requests.length %></span>
            </button>
            <button class="filter-tab" onclick="filterByStatus('pending')">
                Pending
                <span class="count"
                    ><%= requests.filter(r => r.status === 'pending').length %></span
                >
            </button>
            <button class="filter-tab" onclick="filterByStatus('assigned')">
                Assigned
                <span class="count"
                    ><%= requests.filter(r => r.status === 'assigned').length %></span
                >
            </button>
            <button class="filter-tab" onclick="filterByStatus('in_progress')">
                In Progress
                <span class="count"
                    ><%= requests.filter(r => r.status === 'in_progress').length %></span
                >
            </button>
            <button class="filter-tab" onclick="filterByStatus('completed')">
                Completed
                <span class="count"
                    ><%= requests.filter(r => r.status === 'completed').length %></span
                >
            </button>
        </div>

        <div class="filter-controls">
            <div class="left-filters">
                <select id="priorityFilter" onchange="applyFilters()">
                    <option value="all">All Priorities</option>
                    <option value="emergency">Emergency</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>

                <select id="categoryFilter" onchange="applyFilters()">
                    <option value="all">All Categories</option>
                    <option value="electrical">Electrical</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="hvac">HVAC</option>
                    <option value="appliance">Appliance</option>
                    <option value="general_repair">General Repair</option>
                    <option value="other">Other</option>
                </select>

                <div class="search-box filter-select">
                    <input
                        type="text"
                        id="requestSearch"
                        placeholder="Search requests..."
                        onkeyup="applyFilters()"
                    />
                    <i class="fas fa-search"></i>
                </div>
            </div>

            <button class="btn btn-primary" onclick="openCreateServiceRequestModal()">
                <i class="fas fa-plus"></i> Create Service Request
            </button>
        </div>
    </div>

    <!-- Requests List -->
    <div class="requests-list">
        <% if (requests && requests.length > 0) { %> <% requests.forEach(request => { %>
        <div
            class="request-card-full"
            data-request-id="<%= request._id %>"
            data-status="<%= request.status %>"
            data-priority="<%= request.priority %>"
            data-category="<%= request.category %>"
            data-photos="<%- JSON.stringify(request.photos || []) %>"
        >
            <!-- Priority Indicator -->
            <div class="priority-indicator priority-<%= request.priority %>"></div>

            <!-- Request Main Content -->
            <div class="request-main">
                <div class="request-header">
                    <h3><%= request.title %></h3>
                    <div class="request-badges">
                        <span class="badge status-<%= request.status %>"
                            ><%= request.status.replace('_', ' ') %></span
                        >
                        <span class="badge priority-<%= request.priority %>"
                            ><%= request.priority %></span
                        >
                        <span class="category-badge"
                            ><%= request.category.replace('_', ' ') %></span
                        >
                    </div>
                </div>

                <div class="request-info">
                    <div class="info-group">
                        <i class="fas fa-user"></i>
                        <span
                            ><%= request.tenant ? request.tenant.firstName + ' ' +
                            request.tenant.lastName : 'Unknown' %></span
                        >
                    </div>
                    <div class="info-group">
                        <i class="fas fa-home"></i>
                        <span>Unit <%= request.unit ? request.unit.unitNumber : 'N/A' %></span>
                    </div>
                    <div class="info-group">
                        <i class="fas fa-calendar"></i>
                        <span><%= new Date(request.createdAt).toLocaleDateString() %></span>
                    </div>
                    <% if (request.assignedTo) { %>
                    <div class="info-group">
                        <i class="fas fa-wrench"></i>
                        <span
                            >Assigned to: <%= request.assignedTo.firstName %> <%=
                            request.assignedTo.lastName %></span
                        >
                    </div>
                    <% } %>
                </div>

                <div class="request-description">
                    <p><%= request.description %></p>
                </div>

                <% if (request.notes && request.notes.length > 0) { %>
                <div class="request-notes-section">
                    <button class="notes-toggle" onclick="toggleRequestNotes('<%= request._id %>')">
                        <i class="fas fa-comment"></i> Notes (<%= request.notes.length %>)
                    </button>
                    <div
                        id="notes-<%= request._id %>"
                        class="notes-container"
                        style="display: none"
                    >
                        <% request.notes.forEach(note => { %>
                        <div class="note">
                            <div class="note-header">
                                <span class="note-author"
                                    ><%= note.author ? note.author.firstName : 'System' %></span
                                >
                                <span class="note-date"
                                    ><%= new Date(note.createdAt).toLocaleString() %></span
                                >
                            </div>
                            <p><%= note.content %></p>
                        </div>
                        <% }) %>
                    </div>
                </div>
                <% } %>
            </div>

            <!-- Request Actions -->
            <div class="request-actions">
                <% if (request.status !== 'completed' && request.status !== 'cancelled') { %>
                <select
                    class="status-select"
                    onchange="updateStatus('<%= request._id %>', this.value)"
                    data-original-value="<%= request.status %>"
                >
                    <option value="<%= request.status %>" selected>
                        Status: <%= request.status.replace('_', ' ') %>
                    </option>
                    <option value="pending">→ Pending</option>
                    <option value="assigned">→ Assigned</option>
                    <option value="in_progress">→ In Progress</option>
                    <option value="completed">→ Completed</option>
                </select>

                <div class="action-divider"></div>
                <% } %>

                <button
                    class="btn-icon"
                    onclick="viewDetails('<%= request._id %>')"
                    title="View Details"
                >
                    <i class="fas fa-eye"></i>
                    View Details
                </button>

                <button class="btn-icon" onclick="addNote('<%= request._id %>')" title="Add Note">
                    <i class="fas fa-comment-plus"></i>
                    Add Note
                </button>

                <% if (request.status === 'pending' || request.status === 'assigned') { %>
                <div class="action-divider"></div>

                <button
                    class="btn-icon danger"
                    onclick="cancelRequest('<%= request._id %>')"
                    title="Cancel"
                >
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <% } %> <% if (request.status !== 'completed') { %>
                <button
                    class="btn-icon danger"
                    onclick="deleteServiceRequest('<%= request._id %>')"
                    title="Delete"
                >
                    <i class="fas fa-trash"></i>
                    Delete
                </button>
                <% } %>
            </div>
        </div>
        <% }) %> <% } else { %>
        <div class="empty-state">
            <i class="fas fa-tool"></i>
            <h3>No Service Requests</h3>
            <p>There are no service requests at this time</p>
        </div>
        <% } %>
    </div>
</div>

<!-- Assign Technician Modal -->
<div id="assignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Assign Technician</h2>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="assignForm">
                <input type="hidden" id="assignRequestId" name="requestId" />

                <div class="form-group">
                    <label for="technicianId">Select Technician *</label>
                    <select id="technicianId" name="technicianId" required>
                        <option value="">Choose a technician...</option>
                        <optgroup label="Electricians">
                            <option value="tech1">John Smith - Electrician</option>
                            <option value="tech2">Mike Johnson - Electrician</option>
                        </optgroup>
                        <optgroup label="Plumbers">
                            <option value="tech3">David Brown - Plumber</option>
                            <option value="tech4">James Wilson - Plumber</option>
                        </optgroup>
                        <optgroup label="General Repair">
                            <option value="tech5">Robert Davis - General</option>
                            <option value="tech6">William Garcia - General</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label for="assignmentNote">Assignment Note (optional)</label>
                    <textarea
                        id="assignmentNote"
                        name="note"
                        rows="3"
                        placeholder="Add any special instructions for the technician..."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="scheduledDate">Scheduled Date (optional)</label>
                    <input type="datetime-local" id="scheduledDate" name="scheduledDate" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">Assign Technician</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div id="noteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Note</h2>
            <button class="modal-close" onclick="closeNoteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="noteForm">
                <input type="hidden" id="noteRequestId" name="requestId" />

                <div class="form-group">
                    <label for="noteContent">Note *</label>
                    <textarea
                        id="noteContent"
                        name="content"
                        rows="4"
                        required
                        placeholder="Enter your note..."
                    ></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">Add Note</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Service Request Modal -->
<div id="createServiceRequestModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Create Service Request</h2>
            <button class="modal-close" onclick="closeCreateServiceRequestModal()">&times;</button>
        </div>
        <form
            id="createServiceRequestForm"
            enctype="multipart/form-data"
            data-tenant-unit-map="<%= tenantUnitMap %>"
            data-unit-tenant-map="<%= unitTenantMap %>"
        >
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span
                        >Creating a service request on behalf of a tenant. The tenant will be
                        notified.</span
                    >
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="requestTenant">Tenant *</label>
                        <select id="requestTenant" name="tenant" required>
                            <option value="">Select Tenant...</option>
                            <% if (typeof tenants !== 'undefined' && tenants.length > 0) { %> <%
                            tenants.forEach(tenant => { %>
                            <option value="<%= tenant._id %>">
                                <%= tenant.firstName %> <%= tenant.lastName %> (<%= tenant.email %>)
                            </option>
                            <% }) %> <% } %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="requestUnit">Unit *</label>
                        <select id="requestUnit" name="unit" required>
                            <option value="">Select Unit...</option>
                            <% if (typeof units !== 'undefined' && units.length > 0) { %> <%
                            units.forEach(unit => { %>
                            <option value="<%= unit._id %>">
                                Unit <%= unit.unitNumber %><% if (unit.streetAddress) { %> - <%=
                                unit.streetAddress %><% } %>
                            </option>
                            <% }) %> <% } %>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="requestTitle">Title *</label>
                    <input
                        type="text"
                        id="requestTitle"
                        name="title"
                        required
                        placeholder="Brief description of the issue"
                    />
                </div>

                <div class="form-group">
                    <label for="requestDescription">Description *</label>
                    <textarea
                        id="requestDescription"
                        name="description"
                        rows="4"
                        required
                        placeholder="Detailed description of the maintenance issue..."
                    ></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="requestCategory">Category *</label>
                        <select id="requestCategory" name="category" required>
                            <option value="">Select Category...</option>
                            <option value="electrical">Electrical</option>
                            <option value="plumbing">Plumbing</option>
                            <option value="hvac">HVAC</option>
                            <option value="appliance">Appliance</option>
                            <option value="general_repair">General Repair</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="requestPriority">Priority *</label>
                        <select id="requestPriority" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="requestLocation">Location</label>
                        <select id="requestLocation" name="location">
                            <option value="">Select Location...</option>
                            <option value="kitchen">Kitchen</option>
                            <option value="living_room">Living Room</option>
                            <option value="bedroom_master">Master Bedroom</option>
                            <option value="bedroom_other">Other Bedroom</option>
                            <option value="bathroom_master">Master Bathroom</option>
                            <option value="bathroom_other">Other Bathroom</option>
                            <option value="laundry">Laundry</option>
                            <option value="garage">Garage</option>
                            <option value="exterior">Exterior</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="requestPreferredDate">Preferred Date</label>
                        <input type="date" id="requestPreferredDate" name="preferredDate" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="requestPhotos">Photos (Optional)</label>
                    <input type="file" id="requestPhotos" name="photos" accept="image/*" multiple />
                    <small class="form-help">Upload up to 3 photos (Max 10MB each)</small>
                </div>

                <div id="photoPreview" class="photo-preview-grid" style="display: none"></div>
            </div>

            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="closeCreateServiceRequestModal()"
                >
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text"> <i class="fas fa-plus"></i> Create Request </span>
                    <span class="btn-loading" style="display: none">
                        <span class="spinner"></span> Creating...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>
