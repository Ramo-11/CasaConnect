<!-- Tenant Dashboard -->
<div class="tenant-container">
    <!-- Payment Due Banner (if applicable) -->
    <% if (paymentDue && daysOverdue > 5) { %>
    <div class="overdue-banner">
        <div class="overdue-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Your rent is <%= daysOverdue %> days overdue. Please contact management immediately.</span>
            <% if (daysOverdue <= 10) { %>
            <button class="btn btn-danger btn-small" onclick="openPaymentModal()">Pay Now</button>
            <% } %>
        </div>
    </div>
    <% } %>

    <% if (user.requirePasswordChange) { %>
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <span>Please change your password from the default one provided.</span>
        <a href="/tenant/settings" class="btn btn-primary btn-small">Change Password</a>
    </div>
    <% } %>

    <!-- Header with Unit Info -->
    <%- include('../partials/page-header', {
        headerTitle: `Welcome, ${user.firstName}`,
        headerSubtitle: `Unit ${unit.unitNumber} - ${unit.propertyType}`,
        backButton: false,
        headerActions: []
    }) %>

    <!-- Add after the page-header include -->
    <div class="dashboard-top-bar">
        <div class="notifications-dropdown">
            <button class="notification-bell" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <% if (unreadCount > 0) { %>
                <span class="notification-badge"><%= unreadCount %></span>
                <% } %>
            </button>
            <div class="notifications-panel" id="notificationsPanel" style="display: none;">
                <div class="notifications-header">
                    <h4>Notifications</h4>
                    <% if (unreadCount > 0) { %>
                    <button class="btn-link" onclick="markAllAsRead()">Mark all as read</button>
                    <% } %>
                </div>
                <div class="notifications-list">
                    <% if (notifications && notifications.length > 0) { %>
                        <% notifications.forEach(notification => { %>
                        <div class="notification-item priority-<%= notification.priority %>" data-id="<%= notification.id %>">
                            <div class="notification-icon">
                                <i class="fas fa-<%= getNotificationIcon(notification.type) %>"></i>
                            </div>
                            <div class="notification-content">
                                <h5><%= notification.title %></h5>
                                <p><%= notification.message %></p>
                                <span class="notification-time"><%= notification.timeAgo %></span>
                            </div>
                        </div>
                        <% }) %>
                    <% } else { %>
                        <p class="no-notifications">No new notifications</p>
                    <% } %>
                </div>
                <div class="notifications-footer">
                    <a href="/tenant/notifications" class="btn-link">View all notifications</a>
                </div>
            </div>
        </div>
        <a href="/tenant/settings" class="btn btn-secondary">
            <i class="fas fa-cog"></i> Settings
        </a>
        <button class="btn btn-logout" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <%
    // Helper function for notification icons
    function getNotificationIcon(type) {
        const icons = {
            'payment_received': 'check-circle',
            'payment_due': 'exclamation-circle',
            'payment_failed': 'times-circle',
            'service_request_updated': 'tools',
            'service_request_completed': 'check',
            'maintenance_scheduled': 'calendar',
            'announcement': 'bullhorn',
            'system': 'info-circle'
        };
        return icons[type] || 'bell';
    }
    %>

    <!-- Quick Stats -->
    <div class="dashboard-grid">
        <!-- Payment Status Card -->
        <div class="card payment-status-card <%= paymentStatus.class %>" data-days-overdue="<%= daysOverdue %>">
            <div class="card-header">
                <h3>Rent Payment Status</h3>
                <span class="status-badge <%= paymentStatus.class %>"><%= paymentStatus.text %></span>
            </div>
            <div class="card-body">
                <% if (paymentDue) { %>
                    <% if (daysUntilDue > 0) { %>
                        <p class="payment-due-in"><%= daysUntilDue %> days until due</p>
                    <% } else if (daysOverdue <= 5) { %>
                        <p class="payment-warning">Payment due - Pay by the 5th to avoid late fees</p>
                    <% } else { %>
                        <p class="payment-alert">OVERDUE <%= daysOverdue %> days</p>
                        <p class="late-fee-notice">Late fee: $<%= lateFee.toFixed(2) %></p>
                    <% } %>
                    
                    <div class="amount-due">
                        <span class="label">Total Due:</span>
                        <span class="amount">$<%= amountDue.toFixed(2) %></span>
                    </div>
                    
                    <% if (daysOverdue <= 10) { %>
                    <button class="btn btn-primary btn-block btn-large btn-pay-now" onclick="openPaymentModal()">
                        <i class="fas fa-credit-card"></i> Make Payment
                    </button>
                    <% } else { %>
                    <div class="alert alert-danger">
                        <strong>Account on Hold</strong>
                        <p>Please contact management: (555) 123-4567</p>
                    </div>
                    <% } %>
                <% } else { %>
                    <div class="payment-current">
                        <i class="fas fa-check-circle" style="color: #10b981; font-size: 48px;"></i>
                        <p class="mt-3">You're all paid up!</p>
                        <p class="text-muted">Next payment: <%= nextPaymentDate %></p>
                        <p class="amount">$<%= monthlyRent.toFixed(2) %>/month</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Unit Information Card -->
        <div class="card">
            <div class="card-header">
                <h3>Unit Details</h3>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div class="info-item">
                        <label>Unit Number</label>
                        <span><%= unit.unitNumber %></span>
                    </div>
                    <div class="info-item">
                        <label>Type</label>
                        <span><%= unit.propertyType %></span>
                    </div>
                    <div class="info-item">
                        <label>Bedrooms</label>
                        <span><%= unit.bedrooms %></span>
                    </div>
                    <div class="info-item">
                        <label>Bathrooms</label>
                        <span><%= unit.bathrooms %></span>
                    </div>
                    <div class="info-item">
                        <label>Square Feet</label>
                        <span><%= unit.squareFeet %> sq ft</span>
                    </div>
                    <div class="info-item">
                        <label>Monthly Rent</label>
                        <span class="rent-amount">$<%= unit.monthlyRent %></span>
                    </div>
                </div>
                <% if (unit.amenities && unit.amenities.length > 0) { %>
                <div class="amenities-section">
                    <label>Amenities</label>
                    <div class="amenities-list">
                        <% unit.amenities.forEach(amenity => { %>
                        <span class="amenity-tag"><%= amenity %></span>
                        <% }) %>
                    </div>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Lease Information Card -->
        <div class="card">
            <div class="card-header">
                <h3>Lease Information</h3>
                <a href="/tenant/documents" class="btn-link">View Documents</a>
            </div>
            <div class="card-body">
                <div class="lease-info">
                    <div class="info-row">
                        <span class="label">Lease Start:</span>
                        <span class="value"><%= leaseStart %></span>
                    </div>
                    <div class="info-row">
                        <span class="label">Lease End:</span>
                        <span class="value"><%= leaseEnd %></span>
                    </div>
                    <div class="info-row">
                        <span class="label">Time Remaining:</span>
                        <span class="value"><%= leaseRemaining %></span>
                    </div>
                    <div class="info-row">
                        <span class="label">Status:</span>
                        <span class="badge badge-success">Active</span>
                    </div>
                </div>
                <div class="lease-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" data-progress="<%= leaseProgress %>"></div>
                    </div>
                    <small class="text-muted"><%= leaseProgress %>% complete</small>
                </div>
            </div>
        </div>

        <!-- Service Requests Summary Card -->
        <div class="card">
            <div class="card-header">
                <h3>Service Requests</h3>
                <button class="btn btn-primary btn-small" onclick="openServiceRequestModal()">
                    <i class="fas fa-plus"></i> New Request
                </button>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat">
                        <span class="stat-value"><%= activeRequests %></span>
                        <span class="stat-label">Active</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value"><%= completedRequests %></span>
                        <span class="stat-label">Completed</span>
                    </div>
                </div>
                
                <% if (activeServiceRequests && activeServiceRequests.length > 0) { %>
                <div class="recent-requests mt-3">
                    <h5>Recent Requests:</h5>
                    <% activeServiceRequests.slice(0, 3).forEach(request => { %>
                    <div class="request-item">
                        <span class="request-title"><%= request.title %></span>
                        <span class="request-status status-<%= request.status.replace(' ', '_') %>">
                            <%= request.status %>
                        </span>
                    </div>
                    <% }) %>
                </div>
                <% } else { %>
                <p class="no-data">No active service requests</p>
                <% } %>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> $10 fee per service request
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="payments">
            <i class="fas fa-credit-card"></i>
            Payment History
            <% if (paymentDue) { %>
            <span class="badge badge-warning">!</span>
            <% } %>
        </button>
        <button class="tab-button" data-tab="service">
            <i class="fas fa-tools"></i>
            Service Requests
            <% if (activeRequests > 0) { %>
            <span class="badge"><%= activeRequests %></span>
            <% } %>
        </button>
        <button class="tab-button" data-tab="documents">
            <i class="fas fa-file-alt"></i>
            Documents
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Payments Tab -->
        <div id="payments" class="tab-pane active">
            <div class="card">
                <div class="card-header">
                    <h3>Payment History</h3>
                    <div class="filter-controls">
                        <select id="payment-filter" class="filter-select">
                            <option value="all">All Payments</option>
                            <option value="rent">Rent Only</option>
                            <option value="service_fee">Service Fees</option>
                            <option value="late_fee">Late Fees</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <% if (paymentHistory && paymentHistory.length > 0) { %>
                    <div class="table-responsive">
                        <table class="payment-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Receipt</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% paymentHistory.forEach(payment => { %>
                                <tr data-type="<%= payment.type %>">
                                    <td><%= payment.date %></td>
                                    <td>
                                        <span class="type-badge type-<%= payment.type %>">
                                            <%= payment.typeLabel %>
                                        </span>
                                    </td>
                                    <td>$<%= payment.amount.toFixed(2) %></td>
                                    <td><%= payment.method %></td>
                                    <td>
                                        <span class="status-badge status-<%= payment.status %>">
                                            <%= payment.status %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (payment.status === 'completed') { %>
                                        <a href="/receipt/<%= payment.id %>" class="btn-link" target="_blank">View</a>
                                        <% } else { %>
                                        -
                                        <% } %>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <% } else { %>
                    <p class="no-data">No payment history available</p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Service Requests Tab -->
        <div id="service" class="tab-pane">
            <div class="card">
                <div class="card-header">
                    <h3>Active Service Requests</h3>
                    <button class="btn btn-primary btn-small" onclick="openServiceRequestModal()">
                        <i class="fas fa-plus"></i> New Request
                    </button>
                </div>
                <div class="card-body">
                    <% if (activeServiceRequests && activeServiceRequests.length > 0) { %>
                    <div class="requests-list">
                        <% activeServiceRequests.forEach(request => { %>
                        <div class="request-card">
                            <div class="request-header">
                                <h4><%= request.title %></h4>
                                <span class="status-badge status-<%= request.status.replace(' ', '_') %>">
                                    <%= request.status %>
                                </span>
                            </div>
                            <div class="request-meta">
                                <span class="meta-item">
                                    <i class="fas fa-tag"></i> <%= request.category %>
                                </span>
                                <span class="meta-item">
                                    <i class="fas fa-calendar"></i> <%= request.date %>
                                </span>
                                <span class="meta-item priority-<%= request.priority %>">
                                    <i class="fas fa-flag"></i> <%= request.priority %>
                                </span>
                            </div>
                            <p class="request-description"><%= request.description %></p>
                            <% if (request.assignedTo) { %>
                            <div class="assigned-info">
                                <i class="fas fa-user"></i> Assigned to: <%= request.assignedTo %>
                            </div>
                            <% } %>
                            <% if (request.notes && request.notes.length > 0) { %>
                            <button class="btn-link" onclick="toggleNotes('<%= request.id %>')">
                                View Updates (<%= request.notes.length %>)
                            </button>
                            <div id="notes-<%= request.id %>" class="notes-list" style="display: none;">
                                <% request.notes.forEach(note => { %>
                                <div class="note-item">
                                    <p><%= note.content %></p>
                                </div>
                                <% }) %>
                            </div>
                            <% } %>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                    <p class="no-data">No active service requests</p>
                    <% } %>
                </div>
            </div>

            <% if (serviceRequestHistory && serviceRequestHistory.length > 0) { %>
            <div class="card mt-3">
                <div class="card-header">
                    <h3>Completed Requests</h3>
                </div>
                <div class="card-body">
                    <div class="requests-list">
                        <% serviceRequestHistory.forEach(request => { %>
                        <div class="request-card completed">
                            <div class="request-header">
                                <h4><%= request.title %></h4>
                                <span class="completion-date">
                                    Completed: <%= request.completedDate %>
                                </span>
                            </div>
                            <div class="request-meta">
                                <span class="meta-item">
                                    <i class="fas fa-tag"></i> <%= request.category %>
                                </span>
                                <span class="meta-item">
                                    <i class="fas fa-clock"></i> Resolved in <%= request.resolutionTime %>
                                </span>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>
            <% } %>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-pane">
            <div class="card">
                <div class="card-header">
                    <h3>Lease Agreement</h3>
                </div>
                <div class="card-body">
                    <div class="document-item">
                        <div class="document-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div class="document-info">
                            <h4>Residential Lease Agreement</h4>
                            <div class="document-meta">
                                <span><i class="fas fa-calendar"></i> <%= leaseStart %> - <%= leaseEnd %></span>
                                <span><i class="fas fa-home"></i> Unit <%= unit.unitNumber %></span>
                            </div>
                        </div>
                        <div class="document-actions">
                            <a href="/documents/lease/<%= leaseId %>" class="btn btn-secondary" target="_blank">
                                <i class="fas fa-download"></i> View PDF
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <% if (documents && documents.length > 0) { %>
            <div class="card mt-3">
                <div class="card-header">
                    <h3>Other Documents</h3>
                </div>
                <div class="card-body">
                    <div class="document-grid">
                        <% documents.forEach(doc => { %>
                        <div class="document-item">
                            <div class="document-icon">
                                <i class="fas fa-file"></i>
                            </div>
                            <div class="document-info">
                                <h4><%= doc.title %></h4>
                                <span class="document-date"><%= doc.uploadDate %></span>
                            </div>
                            <div class="document-actions">
                                <a href="/documents/<%= doc.id %>" class="btn-link" target="_blank">View</a>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<%- include('../partials/modals/tenant-payment-modal') %>

<!-- Service Request Modal -->
<%- include('../partials/modals/tenant-service-modal') %>